
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Bibhudutt Mohapatro">
      
      
        <link rel="canonical" href="https://github.com/app-PYFRM/op_spark/spark_config.html">
      
      
        <link rel="prev" href="index.html">
      
      
        <link rel="next" href="spark_config_details.html">
      
      
      <link rel="icon" href="img/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.21">
    
    
      
        <title>Spark Configurations - Optimize Spark</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.66ac8b77.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="assert/extra.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="orange" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#spark-configuration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Optimize Spark" class="md-header__button md-logo" aria-label="Optimize Spark" data-md-component="logo">
      
  <img src="img/favicon.ico" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Optimize Spark
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Spark Configurations
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Optimize Spark" class="md-nav__button md-logo" aria-label="Optimize Spark" data-md-component="logo">
      
  <img src="img/favicon.ico" alt="logo">

    </a>
    Optimize Spark
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Spark Setup
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Spark Setup
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Spark Configurations
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="spark_config.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Spark Configurations
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#know-your-data-and-task" class="md-nav__link">
    <span class="md-ellipsis">
      Know Your Data and Task
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark-configuration-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Spark Configuration Tool
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="spark_config_details.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration Details
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utils.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Documentation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="resources.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Resources
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#know-your-data-and-task" class="md-nav__link">
    <span class="md-ellipsis">
      Know Your Data and Task
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spark-configuration-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Spark Configuration Tool
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="spark-configuration">Spark Configuration<a class="headerlink" href="#spark-configuration" title="Permanent link">&para;</a></h1>
<p>Spark Configuration is essential to Spark performance, if properties are set properly , 
then they can boost up the Spark performnce. However, for inexperinced users, it is very 
hard to set up Spark correctly.</p>
<p>This tool provides a convient way to boost up the existing program, so users do not 
need to worry about specific settings.</p>
<p>For Spark resource allocation, the main two settings are total core_number and memory 
size for each executor, while number of cores for each executor is also importent for 
larger jobs.</p>
<ul>
<li>
<p>Total Core numbers</p>
<p>When the total core numbers matches the total partition number, the execution of 
 Spark's tasks achive exceedingly parallel. if the core number is limited, we need to 
 design the core numberto make the partition number be iyts integer multiples. This will 
 help maximum the paralleism.</p>
</li>
<li>
<p>Executor Memory </p>
<p>For all the cores on the same executor, they share the same memory. The memory's
layout shows as below.</p>
<p><img alt="executor_memory_layout" src="img/spark_executor_memory_unified.png" /></p>
<p>According to 
<a href="https://medium.com/walmartglobaltech/decoding-memory-in-spark-parameters-that-are-often-confused-c11be7488a24">Decording Memory in Spark</a>,
 the spark runtime segregates the memory in the driver and executor into
 4 different parts:</p>
<ol>
<li>Storage Memory - memory reserved for cached data </li>
<li>Execution Memory - memory used by data-structures during shuffle operations 
     (joins, group-by's and 
        aggregations).</li>
<li>User Memory - For storing the data-structures created and manged by the 
         user's code </li>
<li>Reserved Memory - Reserved by Spark for internal purpose</li>
</ol>
<p>The default division for execution memory and storage memory is <span class="arithmatex"><span class="MathJax_Preview">60\%</span><script type="math/tex">60\%</script></span> of 
 the total memory, after allowing for 
   300 MB for reserved memory, to safeguard against Out-of-Memory (OOM) errors.
   The reamining User Memory is for used defined functions such as UDF</p>
<p>When storage memory is not being used , Spark can acquire it for use in execution memory for execution 
purposes, and vice versa.</p>
<p>Execution memory is used for Spark shuffles, joins, sorts, and aggregations, Since different 
queries may require different amounts of memory, the fraction
(spark.memory.fraction is 0.6 by default) of the available memory to 
dedicate to this can be 
tricky to tune but it's easy to adjust. By contrast, storage memory is 
primarily used for 
caching user data structures and partitions dervied from Dataframes.</p>
</li>
</ul>
<p>To optimize resource utilization 
and maximize parallelism, the ideal allocation is at least as many partitions as there are cores on 
the executor, as depicted in next figure in <a href="https://pages.databricks.com/rs/094-YMS-629/images/LearningSpark2.0.pdf">Learning Spark , 2<sup>nd</sup> Edition </a>.
if there are more partitions then there are 
cores on each executor, all the cores are kept busy. you can think of partotions as 
atomic units of parallelism: a single thread running on a single cre can work on a 
single partition.
<img alt="relationship between task and cores" src="img/spark_tasks_core_relationship.png" /></p>
<p>To improve performance, some more settings are configured based on recommendations 
from multiple sources (see <a href="resources.html#resources_and_samples">Resources</a>).</p>
<h2 id="know-your-data-and-task">Know Your Data and Task<a class="headerlink" href="#know-your-data-and-task" title="Permanent link">&para;</a></h2>
<p>For Spark tasks, it is very importent to know your data before requesting resources.
If you have a small dataset, it would be overprovisioning (e.g., allocated but unused cores),
and cause unnecessary costs; wwhile it would be underprovisioning(e.g. ,
not sufficient cores for partitions) for large 
scale data may lead to task failure .</p>
<p>In addition, if the Spark tasks involves exploding data (i.e., expanding data 
exponentially), the originally allocated resources may not be enough to complete 
required job, which may lead to OOM failure .
in this case, it is very important to plan the resources wisely. Howver, for inexpericed 
users, it is very difficult to decide how many cores or memory to set aside in advance.</p>
<ul>
<li>
<p><strong>Work Load</strong></p>
<p>For the workaround, we can expect the work load for the tasks. The work 
load can help us get a better estimate on the required resources. Below 
is a list of work load for selected projects </p>
<table>
<thead>
<tr>
<th>Projects</th>
<th>Exploding Data</th>
<th>Work Load</th>
<th>Examples</th>
<th>Shuffle Percentage</th>
</tr>
</thead>
<tbody>
<tr>
<td>Data Analysis</td>
<td>No</td>
<td>Light (L)</td>
<td>Basic Statistics Summaries</td>
<td><span class="arithmatex"><span class="MathJax_Preview">&lt;20\%</span><script type="math/tex"><20\%</script></span></td>
</tr>
<tr>
<td>Data operation</td>
<td>No</td>
<td>Light (L)</td>
<td>Data modification, add/remove columns, etc.</td>
<td><span class="arithmatex"><span class="MathJax_Preview">&lt;10\%</span><script type="math/tex"><10\%</script></span></td>
</tr>
<tr>
<td>Model Evalaution</td>
<td>No</td>
<td>Medium (M)</td>
<td>Data Aggregation, Combining , etc..</td>
<td><span class="arithmatex"><span class="MathJax_Preview">30\%</span><script type="math/tex">30\%</script></span></td>
</tr>
<tr>
<td>Model Fitting</td>
<td>No</td>
<td>Medium Heavy (MH)</td>
<td>Data classifier, Tree building, etc.</td>
<td><span class="arithmatex"><span class="MathJax_Preview">50\%</span><script type="math/tex">50\%</script></span></td>
</tr>
<tr>
<td>Model Exploration</td>
<td>No</td>
<td>Heavy (H)</td>
<td>Multiplier iterations of Model Fitting</td>
<td><span class="arithmatex"><span class="MathJax_Preview">&gt;50\%</span><script type="math/tex">>50\%</script></span></td>
</tr>
<tr>
<td>Model Forcast</td>
<td>No</td>
<td>Extremely Heavy (XH)</td>
<td>Exploding data, multiple operations on data joining and aggregation, etc.</td>
<td><span class="arithmatex"><span class="MathJax_Preview">&gt;80\%</span><script type="math/tex">>80\%</script></span></td>
</tr>
</tbody>
</table>
<p>The shuffle operation includes joins, sorts, and aggregations. When the partitions 
need to be "re-arrayed" to get the output, Spark needs to shuffle the data,
so partitions from cores need to be reassigned.Such operations consume the most 
time and resources </p>
</li>
<li>
<p><strong>File Size</strong></p>
</li>
</ul>
<p>In the HWX HDFS, the default replication factor is 3. So when we use <em>du</em> to 
   check the file size, it usually lists three columns 
   <div class="highlight"><pre><span></span><code><span class="o">(</span>pyfarmbase<span class="o">)</span><span class="w"> </span>hadoop<span class="w"> </span>fs<span class="w"> </span>-du<span class="w"> </span>-h<span class="w"> </span>-s<span class="w"> </span><span class="o">[</span>file/directory<span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>loded<span class="o">]</span>
<span class="o">[</span>size<span class="w"> </span><span class="k">in</span><span class="w"> </span>MB<span class="o">]</span><span class="w"> </span><span class="o">[</span>disk<span class="w"> </span>space<span class="w"> </span>consumed<span class="o">]</span><span class="w"> </span><span class="o">[</span>file/dir<span class="w"> </span>name<span class="o">]</span>
</code></pre></div></p>
<p>Before starting Spark, we need to run the above command to get an estimate of the 
   file storage size </p>
<p>On the other hand, when Spark writes the files to disk, it compresses the data 
   with specific codec, such as snappy ,lz4, gzip, etc. These compression codec
   usually provide good compression ratios. The larger data, the higher the 
   compression ratio is.It is hard to estimate the actual data size by looking solely 
   at the file size without loading the data into Spark, but we expect the real 
   data size is at least <span class="arithmatex"><span class="MathJax_Preview">4-</span><script type="math/tex">4-</script></span>5 times larger then actual file size.</p>
<p>If you expect data will be exploded to a certain rate uin spark operation
   (e.g, snapshot data may be exploded to over 100 times if the forecast 
   horizon is over 100 months ), we define this rate as exploding factor r.
   If there is no exploding operation for the data , the default exploding factor is <span class="arithmatex"><span class="MathJax_Preview">1</span><script type="math/tex">1</script></span>.</p>
<p>We define the file storage size as <span class="arithmatex"><span class="MathJax_Preview">S</span><script type="math/tex">S</script></span> in GB, and make the following assumptions:
   The real data size is <span class="arithmatex"><span class="MathJax_Preview">z</span><script type="math/tex">z</script></span> times larger then the actual file size. In practice 
     <span class="arithmatex"><span class="MathJax_Preview">z</span><script type="math/tex">z</script></span> can be <span class="arithmatex"><span class="MathJax_Preview">4, 5,</span><script type="math/tex">4, 5,</script></span> or larger. When the file size less then <span class="arithmatex"><span class="MathJax_Preview">1</span><script type="math/tex">1</script></span>G, we set <span class="arithmatex"><span class="MathJax_Preview">z=5</span><script type="math/tex">z=5</script></span>. Otherewise,
     we set it to <span class="arithmatex"><span class="MathJax_Preview">4</span><script type="math/tex">4</script></span>, or best estimate on experience.</p>
<h2 id="spark-configuration-tool">Spark Configuration Tool<a class="headerlink" href="#spark-configuration-tool" title="Permanent link">&para;</a></h2>
<p>we design a configuration tool for development purpose.
By using this tool, one does not need to specify each setting individually any more . This tool 
will provide a convenient way to allocate sufficient and optimal resource when the developers
provides the file size and work load for their work.</p>
<p>The following code will obtain a <em>spark</em> session for a modelling job that have an input file with 1GB
and moderate work load.
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">tools.util.optimize_spark</span> <span class="kn">import</span> <span class="o">*</span> 

<span class="n">spark</span> <span class="o">=</span> <span class="n">OptimizeSpark</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="s2">&quot;optimize Spark&quot;</span><span class="p">,</span> <span class="n">spark_queue</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">spark_master</span><span class="o">=</span><span class="s2">&quot;yarn&quot;</span><span class="p">)</span>\
                 <span class="o">.</span><span class="n">start_optimal_spark</span><span class="p">(</span><span class="n">file_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">job_load</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
</code></pre></div>
It also provides an estimate of the total resources requested 
<div class="highlight"><pre><span></span><code>Driver Settings: spark.driver.cores: 7 
Driver Settings: spark.driver.memory: 13g 
Executor Settings: spark.executor.memory: 3g
Executor Settings: spark.executor.cores: 2
Executor Settings: spark.executor.instances: 52
Requested Total Estimate: 163 Core and 187.78 GB Memory 
</code></pre></div></p>
<p>For details of how the configuration settings are calculated, please go to <a href="spark_config_details.html">Configuration Details</a></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": [], "search": "assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.a7c05c9e.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>